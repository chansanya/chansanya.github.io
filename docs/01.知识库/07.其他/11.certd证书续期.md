---
title: certd证书续期
date: 2025-03-13 19:48:52
permalink: /pages/7c8a63/
categories:
  - 知识库
  - 其他
tags:
  - 
author: 
  name: YAN
  link: https://github.com/chansanya
---

你是否还在为3个月的免费证书而烦恼？现在[Certd](#https://github.com/certd/certd)可以解决你的问题。

<!-- more -->

> `[Certd](#https://github.com/certd/certd)` 是一个免费全自动申请和自动部署更新SSL证书的管理系统。 后缀d取自linux守护进程的命名风格，意为证书守护进程。  
> 项目不仅支持证书申请过程自动化，还可以自动化部署更新证书，让你的证书永不过期。

- 全自动申请证书（支持所有注册商注册的域名）
- 全自动部署更新证书（目前支持部署到主机、阿里云、腾讯云等，目前已支持60+部署插件）
- 支持DNS-01、HTTP-01、CNAME代理等多种域名验证方式
- 支持通配符域名/泛域名，支持多个域名打到一个证书上，支持pem、pfx、der、jks等多种证书格式
- 邮件通知、webhook通知
- 私有化部署，数据保存本地，授权信息加密存储，镜像由Github Actions构建，过程公开透明



### docker部署

> 此次和官方示例略有差异，修改了挂载路径
```yaml
version: '3.3'
services:
  certd:
    #指定版本
    image: registry.cn-shenzhen.aliyuncs.com/handsfree/certd:1.31.2
    # 最新版本
    #image: registry.cn-shenzhen.aliyuncs.com/handsfree/certd:latest
    container_name: certd
    restart: unless-stopped
    volumes:
      - ./data:/app/data
    ports:
      - "7001:7001"
      - "7002:7002"
    environment:
      - certd_system_resetAdminPasswd=false
```


::: tip
- http 访问`http://你的IP:7001`
- https访问 `https://你的IP:7002`

默认账号密码：`admin/123456
:::

::: warning
首次登录需要强制修改密码
:::

### 创建流水线

登录后查看`使用教程` 非常详细

::: tip
可将多个域名打在一个证书中：
:::

![img.png](/img/other/certd/img.png)

::: tip
证书申请成功后执行主机命令，如nginx重启等操作
:::
![img.png](/img/other/certd/img_1.png)


::: tip
一切结束后执行操作。发送通知什么的
:::
![img.png](/img/other/certd/img_2.png)

### 数据备份
数据默认存在`/data/certd`目录下，可配置`自定义流水线`自动备份。

### 备份恢复
将备份的`db.sqlite`及同目录下的其他文件一起覆盖到原来的位置，重启certd即可


#### 补一个钉钉机器人推送

::: details 查看代码
**代码目录**

```text
dingding-bot/
├── dingding-bot.py
├── Dockerfile
├── docker-compose.yml
└── requirements.txt
```

**docker-compose.yaml**
```yaml
version: '3.8'

services:
  dingding-bot:
    #使用官方镜像
    image: python:3.11-slim
    #自行编译镜像
    #build: .
    container_name: dingding-bot
    working_dir: /app   
    volumes:
      - .:/app       
    command: sh -c "pip install --no-cache-dir -r requirements.txt && python dingding-bot.py"
    environment:
      - PYTHONUNBUFFERED=1   # 确保 Python 输出是无缓冲的，方便调试
```

**dingding-bot.py**
```python
import hmac
import hashlib
import base64
import urllib.parse
import time
import requests
import json


TALK = {
    "accessToken": "你的 accessToken ",
    "secret": "你的 secret"
}

URL = "https://oapi.dingtalk.com/robot/send"

def url_encode(data):
    # 使用 urllib.parse.quote 进行 URL 编码
    return urllib.parse.quote(data)

def sign(timestamp):
    secret = TALK["secret"]
    # 构造待签名字符串
    string_to_sign = f"{timestamp}\n{secret}"

    # 创建 HmacSHA256 哈希
    hmac_hash = hmac.new(secret.encode('utf-8'), string_to_sign.encode('utf-8'), hashlib.sha256)
    digest = hmac_hash.digest()  # 得到二进制数据

    # 进行 Base64 编码
    base64_encoded = base64.b64encode(digest)

    # URL Encode 得到最终的签名
    return url_encode(base64_encoded.decode('utf-8'))

def get_url(timestamp):
    return f"{URL}?access_token={TALK['accessToken']}&timestamp={timestamp}&sign={sign(timestamp)}"

# 示例调用
timestamp = int(round(time.time() * 1000))

print(timestamp)

url = get_url(timestamp)
print(url)

msg = f"""
### 证书更新通知
**你有一张证书即将过期**,<font color=\"#FF0000\">[去处理](http://你得certd地址:7001)</font></br></br>
"""

data = {
   "msgtype":"markdown",
   "markdown":{
        "title":"证书通知",
        "text":msg,
   }
}

resp = requests.post(url=url,data=json.dumps(data),headers={
        "Content-Type": "application/json"
})
if not resp.ok:
    print("fail")

print(resp.text)
print("success")
```



**requirements.txt**
```yaml
requests
```

也可以使用Dockerfile
```dockerfile
# 使用官方 Python 镜像作为基础镜像
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 将当前目录下的文件复制到容器中的 /app 目录
COPY . /app

# 安装依赖模块
RUN pip install --no-cache-dir -r requirements.txt

# 设置默认命令
CMD ["python", "dingding-bot.py"]
```
:::


更多用法后续补充..
